<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>受講生管理システム</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
        rel="stylesheet">
  <style>
    :root { --primary-soft: #74b9ff; --secondary-soft: #fab1a0; --bg-light: #f9f9fb; }
    body { background-color: var(--bg-light); font-family: "Meiryo", sans-serif; font-size: 0.9rem; }

    /* セクション切り替え */
    .section-view { display: none; }
    .active { display: block; }

    /* トップ画面の巨大カード */
    .nav-card {
        border: none; border-radius: 20px; padding: 40px; text-align: center;
        transition: 0.3s; cursor: pointer; background: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 100%;
    }
    .nav-card:hover { transform: translateY(-10px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .icon-circle {
        width: 80px; height: 80px; background: var(--bg-light);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        margin: 0 auto 20px; font-size: 2.5rem; color: var(--primary-soft);
    }

    /* 検索バー */
    .search-area { background: white; border-radius: 15px; padding: 25px; border-left: 8px solid var(--primary-soft); }

    /* 必須項目のラベル */
    .required::after { content: " *必須"; color: #d63031; font-size: 0.75rem; font-weight: bold; }

    /* テーブル */
    .table-box { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4 py-3 shadow">
  <div class="container">
            <span class="navbar-brand fw-bold" onclick="showSection('portal-home')"
                  style="cursor:pointer">
                <i class="bi bi-person-workspace me-2"></i>受講生管理システム
            </span>
    <button class="btn btn-outline-light btn-sm" onclick="showSection('portal-home')">
      トップメニュー
    </button>
  </div>
</nav>

<div class="container pb-5">

  <div class="section-view active" id="portal-home">
    <div class="row g-4 justify-content-center mt-5">
      <div class="col-md-5">
        <div class="nav-card" onclick="showSection('list-view')">
          <div class="icon-circle"><i class="bi bi-search"></i></div>
          <h4 class="fw-bold">受講生一覧・検索</h4>
          <p class="text-muted">登録されている受講生の情報を検索し、編集・削除が行えます。</p>
          <button class="btn btn-primary rounded-pill px-4">一覧を開く</button>
        </div>
      </div>
      <div class="col-md-5">
        <div class="nav-card" onclick="showRegisterModal()">
          <div class="icon-circle" style="color:var(--secondary-soft);"><i
              class="bi bi-person-plus-fill"></i></div>
          <h4 class="fw-bold">新規受講生登録</h4>
          <p class="text-muted">新しい受講生と受講予定のコース情報をシステムに登録します。</p>
          <button class="btn btn-warning rounded-pill px-4 fw-bold">新規作成</button>
        </div>
      </div>
    </div>
  </div>

  <div class="section-view" id="list-view">
    <div class="search-area shadow-sm mb-4">
      <h6 class="fw-bold mb-3"><i class="bi bi-funnel-fill me-2"></i>検索条件を入力してください</h6>
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="small fw-bold">氏名（部分一致）</label>
          <input class="form-control" id="sName" placeholder="例: 山田" type="text">
        </div>
        <div class="col-md-3">
          <label class="small fw-bold">受講コース名</label>
          <input class="form-control" id="sCourse" placeholder="例: Java" type="text">
        </div>
        <div class="col-md-3">
          <label class="small fw-bold">ステータス</label>
          <select class="form-select" id="sStatus">
            <option value="">すべて表示</option>
            <option value="仮申込">仮申込</option>
            <option value="本申込">本申込</option>
            <option value="受講中">受講中</option>
            <option value="受講終了">受講終了</option>
          </select>
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button class="btn btn-primary w-100 fw-bold" onclick="execSearch()">検索</button>
          <button class="btn btn-outline-secondary" onclick="resetSearch()">クリア</button>
        </div>
      </div>
    </div>

    <div class="table-box">
      <table class="table table-hover align-middle">
        <thead class="table-light">
        <tr>
          <th>UUID</th>
          <th>基本情報</th>
          <th>年齢/性別</th>
          <th>メール/住所</th>
          <th>受講コース/期間</th>
          <th>状況</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="main-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <div class="modal-header border-0 bg-light px-4">
        <h5 class="fw-bold m-0" id="mTitle">データ登録・編集</h5>
        <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
      </div>
      <form class="needs-validation" id="sForm" novalidate>
        <div class="modal-body p-4">
          <input id="fUuid" name="studentUuid" type="hidden">
          <div class="row g-4">
            <div class="col-md-7">
              <h6 class="fw-bold mb-3 text-primary border-bottom pb-2">基本プロフィールの入力</h6>
              <div class="row g-3">
                <div class="col-md-6"><label class="small fw-bold required">氏名</label><input
                    class="form-control" id="fName" name="name" required type="text"></div>
                <div class="col-md-6"><label class="small fw-bold required">フリガナ</label><input
                    class="form-control" id="fFuri" name="furiganaName" required type="text"></div>
                <div class="col-md-6"><label class="small fw-bold">ニックネーム</label><input
                    class="form-control" id="fNick" name="nickname" type="text"></div>
                <div class="col-md-3"><label class="small fw-bold required">年齢</label><input
                    class="form-control" id="fAge" min="0" name="age" required type="number"></div>
                <div class="col-md-3"><label class="small fw-bold required">性別</label><select
                    class="form-select" id="fGen" name="gender" required>
                  <option value="男性">男性</option>
                  <option value="女性">女性</option>
                  <option value="その他">その他</option>
                </select></div>
                <div class="col-md-12"><label
                    class="small fw-bold required">メールアドレス</label><input class="form-control"
                                                                                id="fEmail"
                                                                                name="email"
                                                                                required
                                                                                type="email"></div>
                <div class="col-md-12"><label class="small fw-bold required">住所</label><input
                    class="form-control" id="fAddr" name="address" required type="text"></div>
                <div class="col-md-4"><label class="small fw-bold">削除フラグ</label><select
                    class="form-select" id="fDel" name="isDeleted">
                  <option value="false">有効</option>
                  <option value="true">削除済</option>
                </select></div>
                <div class="col-md-12"><label class="small fw-bold">備考</label><textarea
                    class="form-control" id="fRem" name="remark" rows="2"></textarea></div>
              </div>
            </div>
            <div class="col-md-5">
              <h6 class="fw-bold mb-3 text-success border-bottom pb-2 d-flex justify-content-between">
                コース設定
                <button class="btn btn-sm btn-outline-success" onclick="addCourseRow()"
                        type="button">+ 追加
                </button>
              </h6>
              <div id="course-edit-area" style="max-height: 450px; overflow-y: auto;"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 p-4">
          <button class="btn btn-secondary px-4" data-bs-dismiss="modal" type="button">キャンセル
          </button>
          <button class="btn btn-primary px-5 fw-bold" id="saveBtn" type="button">
            この内容で保存する
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let rawData = [];
  const eModal = new bootstrap.Modal(document.getElementById('editModal'));

  // 【機能1】画面遷移
  function showSection(id) {
      document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if(id === 'list-view') loadAll();
  }

  // 【機能2】検索機能 (MyBatisの @Param("student"), @Param("course") 等に完全準拠)
  function execSearch() {
    const name = document.getElementById('sName').value.trim();
    const course = document.getElementById('sCourse').value.trim();
    const status = document.getElementById('sStatus').value;

    const sp = new URLSearchParams();

    // 【修正】Controllerの引数オブジェクトの中身(フィールド名)を直接指定して送る
    if (name)   sp.append('name', name);
    if (course) sp.append('courseName', course);
    if (status) sp.append('status', status);

    console.log("検索実行中... URL:", `/studentSearch?${sp.toString()}`);

    fetch(`/studentSearch?${sp.toString()}`)
        .then(r => r.json())
        .then(data => {
            renderTable(data); // 検索結果をテーブルに描画
        })
        .catch(e => {
            console.error("検索エラー:", e);
            alert("検索に失敗しました");
        });
}

  function resetSearch() {
      document.getElementById('sName').value = '';
      document.getElementById('sCourse').value = '';
      document.getElementById('sStatus').value = '';
      loadAll();
  }

  function loadAll() {
      fetch('/studentList').then(r => r.json()).then(d => renderTable(d));
  }

  function renderTable(data) {
      rawData = data;
      const b = document.getElementById('main-tbody'); b.innerHTML = '';
      data.forEach(item => {
          const s = item.student, cList = item.studentCourseList;
          const courseHtml = cList.map(c => {
              const st = item.applicationStatusList?.find(x => x.courseUuid === c.courseUuid);
              return `<div class="p-1 small border-start border-primary border-3 mb-1 ms-2">
                  <strong>${c.courseName}</strong><br>
                  <span class="text-muted">${c.startDate || '-'} 〜 ${c.endDate || '-'}</span><br>
                  <span class="badge bg-light text-dark border">${st?.status || '-'}</span>
              </div>`;
          }).join('') || '<span class="text-muted">なし</span>';

          b.innerHTML += `<tr>
              <td><span class="text-secondary small">${s.studentUuid.substring(0,8)}</span></td>
              <td><strong>${s.name}</strong><br><small class="text-primary">@${s.nickname || '-'}</small></td>
              <td>${s.age}歳 / ${s.gender}</td>
              <td><small>${s.email}</small><br><small class="text-muted">${s.address}</small></td>
              <td>${courseHtml}</td>
              <td>${s.isDeleted ? '<span class="badge bg-danger">削除済</span>' : '<span class="badge bg-success">有効</span>'}</td>
              <td><button class="btn btn-sm btn-outline-dark" onclick="showEditModal('${s.studentUuid}')">編集</button></td>
          </tr>`;
      });
  }

  // --- 編集・登録処理 ---
  function showEditModal(uuid) {
      const d = rawData.find(x => x.student.studentUuid === uuid), s = d.student;
      document.getElementById('mTitle').innerText = "受講生情報の編集";
      document.getElementById('fUuid').value = s.studentUuid;
      document.getElementById('fName').value = s.name;
      document.getElementById('fFuri').value = s.furiganaName;
      document.getElementById('fNick').value = s.nickname || '';
      document.getElementById('fAge').value = s.age;
      document.getElementById('fGen').value = s.gender;
      document.getElementById('fEmail').value = s.email;
      document.getElementById('fAddr').value = s.address;
      document.getElementById('fRem').value = s.remark || '';
      document.getElementById('fDel').value = String(s.isDeleted);

      const area = document.getElementById('course-edit-area'); area.innerHTML = '';
      d.studentCourseList.forEach(c => {
          const st = d.applicationStatusList?.find(x => x.courseUuid === c.courseUuid);
          addCourseRow(c.courseName, c.courseUuid, st ? st.status : '仮申込', c.startDate, c.endDate);
      });
      document.getElementById('saveBtn').onclick = () => save('/updateStudent', 'PUT');
      eModal.show();
  }

  function showRegisterModal() {
      document.getElementById('mTitle').innerText = "新規受講生の登録";
      document.getElementById('sForm').reset();
      document.getElementById('fUuid').value = '';
      document.getElementById('course-edit-area').innerHTML = '';
      addCourseRow();
      document.getElementById('saveBtn').onclick = () => save('/registerStudent', 'POST');
      eModal.show();
  }

  function addCourseRow(name = '', uuid = '', status = '仮申込', start = '', end = '') {
      const div = document.createElement('div'); div.className = 'p-3 bg-light rounded-4 mb-3 border';
      div.innerHTML = `
          <input type="text" class="form-control form-control-sm mb-2 c-name" value="${name}" placeholder="コース名" required>
          <input type="hidden" class="c-uuid" value="${uuid}">
          <div class="row g-2 mb-2 small">
              <div class="col-6">開始日<input type="date" class="form-control form-control-sm c-start" value="${start}"></div>
              <div class="col-6">終了日<input type="date" class="form-control form-control-sm c-end" value="${end}"></div>
          </div>
          <div class="d-flex gap-2">
              <select class="form-select form-select-sm c-status">
                  <option value="仮申込" ${status==='仮申込'?'selected':''}>仮申込</option><option value="本申込" ${status==='本申込'?'selected':''}>本申込</option>
                  <option value="受講中" ${status==='受講中'?'selected':''}>受講中</option><option value="受講終了" ${status==='受講終了'?'selected':''}>受講終了</option>
              </select>
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.parentElement.remove()">削除</button>
          </div>`;
      document.getElementById('course-edit-area').appendChild(div);
  }

  function save(url, method) {
      const form = document.getElementById('sForm');
      if (!form.checkValidity()) {
          form.classList.add('was-validated');
          alert("赤い項目（必須入力）を確認してください。");
          return;
      }
      const student = Object.fromEntries(new FormData(form).entries());
      student.age = parseInt(student.age); student.isDeleted = (student.isDeleted === "true");
      const studentCourseList = [], applicationStatusList = [];
      document.querySelectorAll('#course-edit-area > div').forEach(el => {
          const cName = el.querySelector('.c-name').value, cUuid = el.querySelector('.c-uuid').value || null;
          const cStart = el.querySelector('.c-start').value || null, cEnd = el.querySelector('.c-end').value || null, cStatus = el.querySelector('.c-status').value;
          studentCourseList.push({ courseName: cName, courseUuid: cUuid, studentUuid: student.studentUuid, startDate: cStart, endDate: cEnd, isDeleted: false });
          applicationStatusList.push({ status: cStatus, courseUuid: cUuid, isDeleted: false });
      });
      fetch(url, { method: method, headers: {'Content-Type':'application/json'}, body: JSON.stringify({ student, studentCourseList, applicationStatusList }) })
          .then(r => r.ok ? (alert('保存しました'), eModal.hide(), loadAll()) : alert('保存失敗'));
  }
</script>
</body>
</html>